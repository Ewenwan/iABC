<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
  <title>爱上古诗 - 题库</title>
  <link rel="stylesheet" href="./res/layui/css/layui.css">
  <link rel="stylesheet" href="./res/static/css/index.css">
  <script src="./res/layui/layui.js"></script>
  <script src="./libs/axios/axios.min.js"></script>
</head>

<body>
  <!-- nav部分 -->
  <div class="nav">
    <div class="layui-container">
      <div class="nav-logo">
        <h1>爱上古诗 - 题库</h1>
      </div>
      <!-- <div class="nav-list">
        <ul class="layui-nav" lay-filter="">
            <li class="layui-nav-item"><a href="index.html">答案</a></li>
            <li class="layui-nav-item layui-this"><a onclick=getNext()>下一个</a></li>
          </ul>
      </div> -->
    </div>
  </div>

  <!-- main部分 -->
  <div class="main-about">
    <div class="layui-container">
      <div class="layui-row">
        <ul class="aboutab">
          <li>答案</li>
          <li class="layui-this" onclick=getNext()>下一个</li>
        </ul>
        <div class="tabJob">
          <div class="content">
            <p id="topic_view2" class="title" style="text-align: center"></p>
            <p id="answer_view" style="color: #ff00a3"></p>
          </div>
          <div class="content">
            <p id="poem_view"></p>
          </div>
        </div>
        <div class="tabJob">
          <div class="content">
            <p id="topic_view" class="title" style="text-align: center">爱上古诗</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script id="topicView" type="text/html">
    <h1>{{ d.topic }}</h1>
  </script>

  <script id="answerView" type="text/html">
    <h3>{{ d.answer }}</h3>
  </script>

  <script id="poemView" type="text/html">
    <h3>{{ d.title }}</h3>
    <h5>{{ d.author }}</h5>
    <ul>
    {{#  layui.each(d.contentList, function(index, item){ }}
      <li>
        <span>{{ item }}</span>
      </li>
    {{#  }); }}
    {{#  if(d.contentList.length === 0){ }}
      无数据
    {{#  } }} 
    </ul>
  </script>

  <!--[if lt IE 9]>
  <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
  <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
  <script>
    layui.config({
      base: './res/static/js/'
    }).use('firm'); 
  </script>

  <script>
    document.addEventListener("keydown", keydown);

    function keydown(event) {
      //表示键盘监听所触发的事件，同时传递参数event
      switch (event.keyCode) {
        // case 37:
        //   alert("左键");
        //   break;
        case 39:
          // alert("右键");
          getNext();
          break;
      }
    }

    function viewRender(viewId, templateId, data) {
      layui.use('laytpl', function (laytpl) {

        var view = document.getElementById(viewId);
        var getTpl = document.getElementById(templateId).innerHTML;
        var controller = function (view) {
          try {
            var html = laytpl(getTpl).render(data);
            view.innerHTML = html;
          } catch (e) {
            view.innerHTML = '<span style="color: #c00;">' + e.toString() + '</span>';
          }
        };

        controller(view);
      });
    }

    //
    let poemArr = Array();
    let index = 0;
    const NUM = 100; // 一次获取题目的数量

    function getPoems(callback) {
      var url = `/get_topics/${NUM}`;
      // 一次抽取100题
      axios.get(url).then(function (response) {
        callback(response.data);
      });
    }

    function getNext() {
      console.log(index);

      if (poemArr.length === 0 || index === NUM) {
        getPoems((data) => {
          poemArr = data;
          const jsonObj = poemArr[index++];
          render(jsonObj);
        });

        if (index === NUM) {
          index = 0;
        }
      } else {
        const jsonObj = poemArr[index++];
        render(jsonObj);
      }
    }

    function render(jsonObj) {
      let poem = jsonObj.poem;
      poem.contentList = poem.content.split("\n");
      // console.log(poem);

      viewRender('topic_view', "topicView", jsonObj);
      viewRender('topic_view2', "topicView", jsonObj);
      viewRender('answer_view', "answerView", jsonObj);
      viewRender('poem_view', "poemView", poem);
    }
  </script>
</body>

</html>